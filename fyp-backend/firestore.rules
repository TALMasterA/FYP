rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // EXISTING RULE: User Data (Your current rule - PRESERVED)
    // Users can only access their own data
    // ============================================
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ============================================
    // NEW: Feedback Collection (For feedback feature)
    // Authenticated users can submit feedback
    // ============================================
    match /feedback/{feedbackId} {
      // Allow authenticated users to create feedback
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.message is string
                    && request.resource.data.message.size() > 0
                    && request.resource.data.message.size() <= 5000;

      // Feedback is write-only for users (only admins should read - not implemented yet)
      allow read, update, delete: if false;
    }

    // ============================================
    // NEW: Friends Feature - Username Registry
    // ============================================
    match /usernames/{username} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // NEW: Friends Feature - User Search Index
    // ============================================
    match /user_search/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ============================================
    // NEW: Friends Feature - Friend Requests
    // ============================================
    match /friend_requests/{requestId} {
      // Read if sender or receiver
      allow read: if request.auth != null && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );

      // Create if authenticated and sender
      allow create: if request.auth != null 
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.status == "PENDING";

      // Update if receiver (accept/reject) or sender (cancel)
      allow update: if request.auth != null && (
        (resource.data.toUserId == request.auth.uid && 
         request.resource.data.status in ["ACCEPTED", "REJECTED"]) ||
        (resource.data.fromUserId == request.auth.uid && 
         request.resource.data.status == "CANCELLED")
      );

      allow delete: if false;
    }

    // ============================================
    // NEW: Friends Feature - Chat Messages
    // ============================================
    match /chats/{chatId}/messages/{messageId} {
      // Helper function to check if user is participant
      function isParticipant() {
        let metadata = get(/databases/$(database)/documents/chats/$(chatId)/metadata/info).data;
        return request.auth.uid in metadata.participants;
      }

      // Read if participant in chat
      allow read: if request.auth != null && isParticipant();

      // Create if participant and sender matches auth.uid
      allow create: if request.auth != null 
        && isParticipant()
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.content.size() > 0
        && request.resource.data.content.size() <= 2000;

      // Update only allowed for marking as read
      allow update: if request.auth != null 
        && isParticipant()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);

      allow delete: if false;
    }

    // ============================================
    // NEW: Friends Feature - Chat Metadata
    // ============================================
    match /chats/{chatId}/metadata/info {
      function isParticipant() {
        return request.auth.uid in resource.data.participants;
      }

      allow read: if request.auth != null && isParticipant();
      allow write: if request.auth != null && request.auth.uid in request.resource.data.participants;
    }

    // ============================================
    // DEFAULT: Deny all other access
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

